
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Volume slicer advanced example &#8212; mayavi 4.6.1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Polydata example" href="example_polydata.html" />
    <link rel="prev" title="Coil design application example" href="example_coil_design_application.html" />
<style type="text/css">
  body {
    /* Very bottom copyright, etc. info */
    background: #4d598d;
  }

  .documentwrapper {
    /* Blank area on left bar */
    background: #24326e;
  }

  .related {
    /* Long horizontal nav bars */
    background: #3c4b8a!important;
  }

  .sphinxsidebarwrapper {
    /* Filled part of left sidebar */
    background: #24326e;
  }

  a {
    color: #253370;
  }

  .sphinxsidebarwrapper a {
    color: #f2f2f2!important;
  }
</style>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="example_polydata.html" title="Polydata example"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="example_coil_design_application.html" title="Coil design application example"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">mayavi 4.6.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="examples.html" accesskey="U">Example gallery</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="volume-slicer-advanced-example">
<span id="example-volume-slicer-advanced"></span><h1>Volume slicer advanced example<a class="headerlink" href="#volume-slicer-advanced-example" title="Permalink to this headline">¶</a></h1>
<p>An efficient implementation of the triple-plane view showing 3 cut planes
on volumetric data, and side views showing each cut, with a cursor to
move the other cuts.</p>
<p>This is an example of complex callback interaction. It builds on the
<a class="reference internal" href="example_volume_slicer.html#example-volume-slicer"><span class="std std-ref">Volume slicer example</span></a> but has more complex logic. You should try
to understand the <a class="reference internal" href="example_volume_slicer.html#example-volume-slicer"><span class="std std-ref">Volume slicer example</span></a> first.</p>
<p>In this example, the VolumeSlicer object displays a position attribute
giving the position of the cut in data coordinates. Traits callbacks are
used to move the cut planes when this position attribute is modifed.</p>
<p>In the 3D window, the 3D cuts are displayed using ImagePlaneWidgets
cutting the 3D volumetric data. The data extracted by the
ImagePlaneWidgets for plotting is captured using the TVTK
ImagePlaneWidget’s <cite>_get_reslice_output</cite> method. The resulting dataset is
plotted in each side view using another ImagePlaneWidget. As a result the
data is not copied (at the VTK level, there is only one pipeline), and
modifications of the data plotted on the planes in the 3D view (for
instance when these planes are moved) are propagated to the 2D side views
by the VTK pipeline.</p>
<p>A cursor is displayed in each side view using a glyph. The cursor
indicates the position of the cut.</p>
<p>In the side view, when the mouse button is pressed on the planes, it
creates a VTK <cite>InteractionEvent</cite>. When this happens, VTK calls an
callback (observer, it VTK terms), that we use to move the position of
the cut. The Traits callbacks do the rest for the updating.</p>
<p><strong>Python source code:</strong> <a class="reference download internal" href="../_downloads/volume_slicer_advanced.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">volume_slicer_advanced.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">import numpy as np</span>

<span class="s2">from traits.api import HasTraits, Instance, Array, </span><span class="se">\</span>
<span class="s2">    Bool, Dict, on_trait_change</span>
<span class="s2">from traitsui.api import View, Item, HGroup, Group</span>

<span class="s2">from tvtk.api import tvtk</span>
<span class="s2">from tvtk.pyface.scene import Scene</span>

<span class="s2">from mayavi import mlab</span>
<span class="s2">from mayavi.core.api import PipelineBase, Source</span>
<span class="s2">from mayavi.core.ui.api import SceneEditor, MlabSceneModel</span>


<span class="s2">################################################################################</span>
<span class="s2"># The object implementing the dialog</span>
<span class="s2">class VolumeSlicer(HasTraits):</span>
<span class="s2">    # The data to plot</span>
<span class="s2">    data = Array</span>

<span class="s2">    # The position of the view</span>
<span class="s2">    position = Array(shape=(3,))</span>

<span class="s2">    # The 4 views displayed</span>
<span class="s2">    scene3d = Instance(MlabSceneModel, ())</span>
<span class="s2">    scene_x = Instance(MlabSceneModel, ())</span>
<span class="s2">    scene_y = Instance(MlabSceneModel, ())</span>
<span class="s2">    scene_z = Instance(MlabSceneModel, ())</span>

<span class="s2">    # The data source</span>
<span class="s2">    data_src = Instance(Source)</span>

<span class="s2">    # The image plane widgets of the 3D scene</span>
<span class="s2">    ipw_3d_x = Instance(PipelineBase)</span>
<span class="s2">    ipw_3d_y = Instance(PipelineBase)</span>
<span class="s2">    ipw_3d_z = Instance(PipelineBase)</span>

<span class="s2">    # The cursors on each view:</span>
<span class="s2">    cursors = Dict()</span>

<span class="s2">    disable_render = Bool</span>

<span class="s2">    _axis_names = dict(x=0, y=1, z=2)</span>

<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    # Object interface</span>
<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    def __init__(self, **traits):</span>
<span class="s2">        super(VolumeSlicer, self).__init__(**traits)</span>
<span class="s2">        # Force the creation of the image_plane_widgets:</span>
<span class="s2">        self.ipw_3d_x</span>
<span class="s2">        self.ipw_3d_y</span>
<span class="s2">        self.ipw_3d_z</span>


<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    # Default values</span>
<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    def _position_default(self):</span>
<span class="s2">        return 0.5*np.array(self.data.shape)</span>

<span class="s2">    def _data_src_default(self):</span>
<span class="s2">        return mlab.pipeline.scalar_field(self.data,</span>
<span class="s2">                            figure=self.scene3d.mayavi_scene,</span>
<span class="s2">                            name=&#39;Data&#39;,)</span>

<span class="s2">    def make_ipw_3d(self, axis_name):</span>
<span class="s2">        ipw = mlab.pipeline.image_plane_widget(self.data_src,</span>
<span class="s2">                        figure=self.scene3d.mayavi_scene,</span>
<span class="s2">                        plane_orientation=&#39;</span><span class="si">%s</span><span class="s2">_axes&#39; % axis_name,</span>
<span class="s2">                        name=&#39;Cut </span><span class="si">%s</span><span class="s2">&#39; % axis_name)</span>
<span class="s2">        return ipw</span>

<span class="s2">    def _ipw_3d_x_default(self):</span>
<span class="s2">        return self.make_ipw_3d(&#39;x&#39;)</span>

<span class="s2">    def _ipw_3d_y_default(self):</span>
<span class="s2">        return self.make_ipw_3d(&#39;y&#39;)</span>

<span class="s2">    def _ipw_3d_z_default(self):</span>
<span class="s2">        return self.make_ipw_3d(&#39;z&#39;)</span>


<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    # Scene activation callbacks</span>
<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    @on_trait_change(&#39;scene3d.activated&#39;)</span>
<span class="s2">    def display_scene3d(self):</span>
<span class="s2">        outline = mlab.pipeline.outline(self.data_src,</span>
<span class="s2">                        figure=self.scene3d.mayavi_scene,</span>
<span class="s2">                        )</span>
<span class="s2">        self.scene3d.mlab.view(40, 50)</span>
<span class="s2">        # Interaction properties can only be changed after the scene</span>
<span class="s2">        # has been created, and thus the interactor exists</span>
<span class="s2">        for ipw in (self.ipw_3d_x, self.ipw_3d_y, self.ipw_3d_z):</span>
<span class="s2">            ipw.ipw.interaction = 0</span>
<span class="s2">        self.scene3d.scene.background = (0, 0, 0)</span>
<span class="s2">        # Keep the view always pointing up</span>
<span class="s2">        self.scene3d.scene.interactor.interactor_style = </span><span class="se">\</span>
<span class="s2">                                 tvtk.InteractorStyleTerrain()</span>
<span class="s2">        self.update_position()</span>


<span class="s2">    def make_side_view(self, axis_name):</span>
<span class="s2">        scene = getattr(self, &#39;scene_</span><span class="si">%s</span><span class="s2">&#39; % axis_name)</span>
<span class="s2">        scene.scene.parallel_projection = True</span>
<span class="s2">        ipw_3d   = getattr(self, &#39;ipw_3d_</span><span class="si">%s</span><span class="s2">&#39; % axis_name)</span>

<span class="s2">        # We create the image_plane_widgets in the side view using a</span>
<span class="s2">        # VTK dataset pointing to the data on the corresponding</span>
<span class="s2">        # image_plane_widget in the 3D view (it is returned by</span>
<span class="s2">        # ipw_3d._get_reslice_output())</span>
<span class="s2">        side_src = ipw_3d.ipw._get_reslice_output()</span>
<span class="s2">        ipw = mlab.pipeline.image_plane_widget(</span>
<span class="s2">                            side_src,</span>
<span class="s2">                            plane_orientation=&#39;z_axes&#39;,</span>
<span class="s2">                            vmin=self.data.min(),</span>
<span class="s2">                            vmax=self.data.max(),</span>
<span class="s2">                            figure=scene.mayavi_scene,</span>
<span class="s2">                            name=&#39;Cut view </span><span class="si">%s</span><span class="s2">&#39; % axis_name,</span>
<span class="s2">                            )</span>
<span class="s2">        setattr(self, &#39;ipw_</span><span class="si">%s</span><span class="s2">&#39; % axis_name, ipw)</span>

<span class="s2">        # Extract the spacing of the side_src to convert coordinates</span>
<span class="s2">        # into indices</span>
<span class="s2">        spacing = side_src.spacing</span>

<span class="s2">        # Make left-clicking create a crosshair</span>
<span class="s2">        ipw.ipw.left_button_action = 0</span>

<span class="s2">        x, y, z = self.position</span>
<span class="s2">        cursor = mlab.points3d(x, y, z,</span>
<span class="s2">                            mode=&#39;axes&#39;,</span>
<span class="s2">                            color=(0, 0, 0),</span>
<span class="s2">                            scale_factor=2*max(self.data.shape),</span>
<span class="s2">                            figure=scene.mayavi_scene,</span>
<span class="s2">                            name=&#39;Cursor view </span><span class="si">%s</span><span class="s2">&#39; % axis_name,</span>
<span class="s2">                        )</span>
<span class="s2">        self.cursors[axis_name] = cursor</span>

<span class="s2">        # Add a callback on the image plane widget interaction to</span>
<span class="s2">        # move the others</span>
<span class="s2">        this_axis_number = self._axis_names[axis_name]</span>
<span class="s2">        def move_view(obj, evt):</span>
<span class="s2">            # Disable rendering on all scene</span>
<span class="s2">            position = list(obj.GetCurrentCursorPosition()*spacing)[:2]</span>
<span class="s2">            position.insert(this_axis_number, self.position[this_axis_number])</span>
<span class="s2">            # We need to special case y, as the view has been rotated.</span>
<span class="s2">            if axis_name is &#39;y&#39;:</span>
<span class="s2">                position = position[::-1]</span>
<span class="s2">            self.position = position</span>

<span class="s2">        ipw.ipw.add_observer(&#39;InteractionEvent&#39;, move_view)</span>
<span class="s2">        ipw.ipw.add_observer(&#39;StartInteractionEvent&#39;, move_view)</span>

<span class="s2">        # Center the image plane widget</span>
<span class="s2">        ipw.ipw.slice_position = 0.5*self.data.shape[</span>
<span class="s2">                                        self._axis_names[axis_name]]</span>

<span class="s2">        # 2D interaction: only pan and zoom</span>
<span class="s2">        scene.scene.interactor.interactor_style = </span><span class="se">\</span>
<span class="s2">                                 tvtk.InteractorStyleImage()</span>
<span class="s2">        scene.scene.background = (0, 0, 0)</span>

<span class="s2">        # Some text:</span>
<span class="s2">        mlab.text(0.01, 0.8, axis_name, width=0.08)</span>

<span class="s2">        # Choose a view that makes sens</span>
<span class="s2">        views = dict(x=(0, 0), y=(90, 180), z=(0, 0))</span>
<span class="s2">        mlab.view(views[axis_name][0],</span>
<span class="s2">                  views[axis_name][1],</span>
<span class="s2">                  focalpoint=0.5*np.array(self.data.shape),</span>
<span class="s2">                  figure=scene.mayavi_scene)</span>
<span class="s2">        scene.scene.camera.parallel_scale = 0.52*np.mean(self.data.shape)</span>

<span class="s2">    @on_trait_change(&#39;scene_x.activated&#39;)</span>
<span class="s2">    def display_scene_x(self):</span>
<span class="s2">        return self.make_side_view(&#39;x&#39;)</span>

<span class="s2">    @on_trait_change(&#39;scene_y.activated&#39;)</span>
<span class="s2">    def display_scene_y(self):</span>
<span class="s2">        return self.make_side_view(&#39;y&#39;)</span>

<span class="s2">    @on_trait_change(&#39;scene_z.activated&#39;)</span>
<span class="s2">    def display_scene_z(self):</span>
<span class="s2">        return self.make_side_view(&#39;z&#39;)</span>


<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    # Traits callback</span>
<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    @on_trait_change(&#39;position&#39;)</span>
<span class="s2">    def update_position(self):</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="n">Update</span> <span class="n">the</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">cursors</span> <span class="n">on</span> <span class="n">each</span> <span class="n">side</span> <span class="n">view</span><span class="p">,</span> <span class="k">as</span> <span class="n">well</span>
            <span class="k">as</span> <span class="n">the</span> <span class="n">image_plane_widgets</span> <span class="ow">in</span> <span class="n">the</span> <span class="mi">3</span><span class="n">D</span> <span class="n">view</span><span class="o">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # First disable rendering in all scenes to avoid unecessary</span>
<span class="s2">        # renderings</span>
<span class="s2">        self.disable_render = True</span>

<span class="s2">        # For each axis, move image_plane_widget and the cursor in the</span>
<span class="s2">        # side view</span>
<span class="s2">        for axis_name, axis_number in self._axis_names.items():</span>
<span class="s2">            ipw3d = getattr(self, &#39;ipw_3d_</span><span class="si">%s</span><span class="s2">&#39; % axis_name)</span>
<span class="s2">            ipw3d.ipw.slice_position = self.position[axis_number]</span>

<span class="s2">            # Go from the 3D position, to the 2D coordinates in the</span>
<span class="s2">            # side view</span>
<span class="s2">            position2d = list(self.position)</span>
<span class="s2">            position2d.pop(axis_number)</span>
<span class="s2">            if axis_name is &#39;y&#39;:</span>
<span class="s2">                position2d = position2d[::-1]</span>
<span class="s2">            # Move the cursor</span>
<span class="s2">            # For the following to work, you need Mayavi 3.4.0, if you</span>
<span class="s2">            # have a less recent version, use &#39;x=[position2d[0]]&#39;</span>
<span class="s2">            self.cursors[axis_name].mlab_source.trait_set(</span>
<span class="s2">                x=position2d[0], y=position2d[1], z=0)</span>

<span class="s2">        # Finally re-enable rendering</span>
<span class="s2">        self.disable_render = False</span>

<span class="s2">    @on_trait_change(&#39;disable_render&#39;)</span>
<span class="s2">    def _render_enable(self):</span>
<span class="s2">        for scene in (self.scene3d, self.scene_x, self.scene_y,</span>
<span class="s2">                                                  self.scene_z):</span>
<span class="s2">            scene.scene.disable_render = self.disable_render</span>


<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    # The layout of the dialog created</span>
<span class="s2">    #---------------------------------------------------------------------------</span>
<span class="s2">    view = View(HGroup(</span>
<span class="s2">                  Group(</span>
<span class="s2">                       Item(&#39;scene_y&#39;,</span>
<span class="s2">                            editor=SceneEditor(scene_class=Scene),</span>
<span class="s2">                            height=250, width=300),</span>
<span class="s2">                       Item(&#39;scene_z&#39;,</span>
<span class="s2">                            editor=SceneEditor(scene_class=Scene),</span>
<span class="s2">                            height=250, width=300),</span>
<span class="s2">                       show_labels=False,</span>
<span class="s2">                  ),</span>
<span class="s2">                  Group(</span>
<span class="s2">                       Item(&#39;scene_x&#39;,</span>
<span class="s2">                            editor=SceneEditor(scene_class=Scene),</span>
<span class="s2">                            height=250, width=300),</span>
<span class="s2">                       Item(&#39;scene3d&#39;,</span>
<span class="s2">                            editor=SceneEditor(scene_class=Scene),</span>
<span class="s2">                            height=250, width=300),</span>
<span class="s2">                       show_labels=False,</span>
<span class="s2">                  ),</span>
<span class="s2">                ),</span>
<span class="s2">                resizable=True,</span>
<span class="s2">                title=&#39;Volume Slicer&#39;,</span>
<span class="s2">                )</span>


<span class="s2">################################################################################</span>
<span class="s2">if __name__ == &#39;__main__&#39;:</span>
<span class="s2">    # Create some data</span>
<span class="s2">    x, y, z = np.ogrid[-5:5:100j, -5:5:100j, -5:5:100j]</span>
<span class="s2">    data = np.sin(3*x)/x + 0.05*z**2 + np.cos(3*y)</span>

<span class="s2">    m = VolumeSlicer(data=data)</span>
<span class="s2">    m.configure_traits()</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/mayavi-logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="example_coil_design_application.html"
                        title="previous chapter">Coil design application example</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="example_polydata.html"
                        title="next chapter">Polydata example</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/auto/example_volume_slicer_advanced.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="example_polydata.html" title="Polydata example"
             >next</a> |</li>
        <li class="right" >
          <a href="example_coil_design_application.html" title="Coil design application example"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">mayavi 4.6.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="examples.html" >Example gallery</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2008-2018, Enthought Inc..
      Last updated on Aug 08, 2018.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.1.
    </div>
  </body>
</html>