
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Coil design application example &#8212; mayavi 4.6.1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Volume slicer advanced example" href="example_volume_slicer_advanced.html" />
    <link rel="prev" title="Volume slicer example" href="example_volume_slicer.html" />
<style type="text/css">
  body {
    /* Very bottom copyright, etc. info */
    background: #4d598d;
  }

  .documentwrapper {
    /* Blank area on left bar */
    background: #24326e;
  }

  .related {
    /* Long horizontal nav bars */
    background: #3c4b8a!important;
  }

  .sphinxsidebarwrapper {
    /* Filled part of left sidebar */
    background: #24326e;
  }

  a {
    color: #253370;
  }

  .sphinxsidebarwrapper a {
    color: #f2f2f2!important;
  }
</style>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="example_volume_slicer_advanced.html" title="Volume slicer advanced example"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="example_volume_slicer.html" title="Volume slicer example"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">mayavi 4.6.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="examples.html" accesskey="U">Example gallery</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="coil-design-application-example">
<span id="example-coil-design-application"></span><h1>Coil design application example<a class="headerlink" href="#coil-design-application-example" title="Permalink to this headline">Â¶</a></h1>
<p>An full-blown application demoing a domain-specific usecase with Mayavi:
interactive design of coils.</p>
<p>This is example of electromagnetic coils design, an application is built to
enable a user to interactively position current loops while visualizing the
resulting magnetic field. For this purpose, it is best to use object-oriented
programming. Each current loop is written as an object (the <cite>Loop</cite> class), with
position, radius and direction attributes, and that knows how to calculate the
magnetic field it generates: its <cite>Bnorm</cite> is a property, that is recomputed when
the loop characteristic changes. These loop objects are available to the main
application class as a list. The total magnetic field created is the sum of
each individual magnetic field. It can be visualized via a Mayavi scene
embedded in the application class. As we use Traited objects for the current
loops, a dialog enabling modification of their attributes can be generated by
Traits and embedded in our application.</p>
<p>The full power of Mayavi is available to the application. Via the pipeline tree
view, the user can modify the visualization. Familiar interaction and movements
are possible in the figure. So is saving the visualization, or loading data. In
addition, as the visualization model, described by the pipeline, is separated
from the data that is visualized, contained in the data source, any
visualization module added by the user will update when coils are added or
changed.</p>
<p>Simpler examples of magnetic field visualization can be found on
<a class="reference internal" href="example_magnetic_field_lines.html#example-magnetic-field-lines"><span class="std std-ref">Magnetic field lines example</span></a> and <a class="reference internal" href="example_magnetic_field.html#example-magnetic-field"><span class="std std-ref">Magnetic field example</span></a>.
The material required to understand this example is covered in section
<a class="reference internal" href="../building_applications.html#builing-applications"><span class="std std-ref">Building applications using Mayavi</span></a>.</p>
<p><strong>Python source code:</strong> <a class="reference download internal" href="../_downloads/coil_design_application.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">coil_design_application.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2"># Author: Gael Varoquaux &lt;gael.varoquaux@normalesup.org&gt;</span>
<span class="s2"># Copyright (c) 2009, Enthought, Inc.</span>
<span class="s2"># License: BSD Style.</span>

<span class="s2"># Major scientific library imports</span>
<span class="s2">import numpy as np</span>
<span class="s2">from scipy import linalg, special</span>

<span class="s2"># Enthought library imports:</span>
<span class="s2">from traits.api import HasTraits, Array, CFloat, List, </span><span class="se">\</span>
<span class="s2">   Instance, on_trait_change, Property</span>
<span class="s2">from traitsui.api import Item, View, ListEditor, </span><span class="se">\</span>
<span class="s2">        HSplit, VSplit</span>
<span class="s2">from mayavi.core.ui.api import EngineView, MlabSceneModel, </span><span class="se">\</span>
<span class="s2">        SceneEditor</span>

<span class="s2">##############################################################################</span>
<span class="s2"># Module-level variables</span>

<span class="s2"># The grid of points on which we want to evaluate the field</span>
<span class="s2">X, Y, Z = np.mgrid[-0.15:0.15:20j, -0.15:0.15:20j, -0.15:0.15:20j]</span>
<span class="s2"># Avoid rounding issues :</span>
<span class="s2">f = 1e4  # this gives the precision we are interested by :</span>
<span class="s2">X = np.round(X * f) / f</span>
<span class="s2">Y = np.round(Y * f) / f</span>
<span class="s2">Z = np.round(Z * f) / f</span>

<span class="s2">##############################################################################</span>
<span class="s2"># A current loop class</span>
<span class="s2">class Loop(HasTraits):</span>
<span class="s2">    &quot;&quot;&quot;</span> <span class="n">A</span> <span class="n">current</span> <span class="n">loop</span> <span class="n">class</span><span class="o">.</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    #-------------------------------------------------------------------------</span>
<span class="sd">    # Public traits</span>
<span class="sd">    #-------------------------------------------------------------------------</span>
<span class="sd">    direction = Array(float, value=(0, 0, 1), cols=3,</span>
<span class="sd">                    shape=(3,), desc=&#39;directing vector of the loop&#39;,</span>
<span class="sd">                    enter_set=True, auto_set=False)</span>

<span class="sd">    radius    = CFloat(0.1, desc=&#39;radius of the loop&#39;,</span>
<span class="sd">                    enter_set=True, auto_set=False)</span>

<span class="sd">    position  = Array(float, value=(0, 0, 0), cols=3,</span>
<span class="sd">                    shape=(3,), desc=&#39;position of the center of the loop&#39;,</span>
<span class="sd">                    enter_set=True, auto_set=False)</span>

<span class="sd">    _plot      = None</span>

<span class="sd">    Bnorm   = Property(depends_on=&#39;direction,position,radius&#39;)</span>

<span class="sd">    view = View(&#39;position&#39;, &#39;direction&#39;, &#39;radius&#39;, &#39;_&#39;)</span>


<span class="sd">    #-------------------------------------------------------------------------</span>
<span class="sd">    # Loop interface</span>
<span class="sd">    #-------------------------------------------------------------------------</span>
<span class="sd">    def base_vectors(self):</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="n">Returns</span> <span class="mi">3</span> <span class="n">orthognal</span> <span class="n">base</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">the</span> <span class="n">first</span> <span class="n">one</span> <span class="n">colinear</span> <span class="n">to</span>
            <span class="n">the</span> <span class="n">axis</span> <span class="n">of</span> <span class="n">the</span> <span class="n">loop</span><span class="o">.</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # normalize n</span>
<span class="sd">        n = self.direction / (self.direction**2).sum(axis=-1)</span>

<span class="sd">        # choose two vectors perpendicular to n</span>
<span class="sd">        # choice is arbitrary since the coil is symetric about n</span>
<span class="sd">        if  np.abs(n[0])==1 :</span>
<span class="sd">            l = np.r_[n[2], 0, -n[0]]</span>
<span class="sd">        else:</span>
<span class="sd">            l = np.r_[0, n[2], -n[1]]</span>

<span class="sd">        l /= (l**2).sum(axis=-1)</span>
<span class="sd">        m = np.cross(n, l)</span>
<span class="sd">        return n, l, m</span>


<span class="sd">    @on_trait_change(&#39;Bnorm&#39;)</span>
<span class="sd">    def redraw(self):</span>
<span class="sd">        if hasattr(self, &#39;app&#39;) and self.app.scene._renderer is not None:</span>
<span class="sd">            self.display()</span>
<span class="sd">            self.app.visualize_field()</span>


<span class="sd">    def display(self):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Display</span> <span class="n">the</span> <span class="n">coil</span> <span class="ow">in</span> <span class="n">the</span> <span class="mi">3</span><span class="n">D</span> <span class="n">view</span><span class="o">.</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        n, l, m = self.base_vectors()</span>
<span class="sd">        theta = np.linspace(0, 2*np.pi, 30)[..., np.newaxis]</span>
<span class="sd">        coil = self.radius*(np.sin(theta)*l + np.cos(theta)*m)</span>
<span class="sd">        coil += self.position</span>
<span class="sd">        coil_x, coil_y, coil_z = coil.T</span>
<span class="sd">        if self._plot is None:</span>
<span class="sd">            self._plot = self.app.scene.mlab.plot3d(coil_x, coil_y, coil_z,</span>
<span class="sd">                                    tube_radius=0.007, color=(0, 0, 1),</span>
<span class="sd">                                    name=&#39;Coil&#39;)</span>
<span class="sd">        else:</span>
<span class="sd">            self._plot.mlab_source.trait_set(x=coil_x, y=coil_y, z=coil_z)</span>


<span class="sd">    def _get_Bnorm(self):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="n">the</span> <span class="n">magnetic</span> <span class="n">field</span> <span class="k">for</span> <span class="n">the</span> <span class="n">current</span> <span class="n">loop</span> <span class="n">calculated</span>
        <span class="kn">from</span> <span class="nn">eqns</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">Phys</span> <span class="n">Rev</span> <span class="n">A</span> <span class="n">Vol</span><span class="o">.</span> <span class="mi">35</span><span class="p">,</span> <span class="n">N</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span> <span class="mi">1535</span><span class="o">-</span><span class="mi">1546</span><span class="p">;</span> <span class="mf">1987.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ### Translate the coordinates in the coil&#39;s frame</span>
<span class="s2">        n, l, m = self.base_vectors()</span>
<span class="s2">        R       = self.radius</span>
<span class="s2">        r0      = self.position</span>
<span class="s2">        r       = np.c_[np.ravel(X), np.ravel(Y), np.ravel(Z)]</span>

<span class="s2">        # transformation matrix coil frame to lab frame</span>
<span class="s2">        trans = np.vstack((l, m, n))</span>

<span class="s2">        r -= r0   #point location from center of coil</span>
<span class="s2">        r = np.dot(r, linalg.inv(trans) )           #transform vector to coil frame</span>

<span class="s2">        #### calculate field</span>

<span class="s2">        # express the coordinates in polar form</span>
<span class="s2">        x = r[:, 0]</span>
<span class="s2">        y = r[:, 1]</span>
<span class="s2">        z = r[:, 2]</span>
<span class="s2">        rho = np.sqrt(x**2 + y**2)</span>
<span class="s2">        theta = np.arctan2(x, y)</span>

<span class="s2">        E = special.ellipe((4 * R * rho)/( (R + rho)**2 + z**2))</span>
<span class="s2">        K = special.ellipk((4 * R * rho)/( (R + rho)**2 + z**2))</span>
<span class="s2">        Bz =  1/np.sqrt((R + rho)**2 + z**2) * (</span>
<span class="s2">                    K</span>
<span class="s2">                  + E * (R**2 - rho**2 - z**2)/((R - rho)**2 + z**2)</span>
<span class="s2">                )</span>
<span class="s2">        Brho = z/(rho*np.sqrt((R + rho)**2 + z**2)) * (</span>
<span class="s2">                -K</span>
<span class="s2">                + E * (R**2 + rho**2 + z**2)/((R - rho)**2 + z**2)</span>
<span class="s2">                )</span>
<span class="s2">        # On the axis of the coil we get a divided by zero here. This returns a</span>
<span class="s2">        # NaN, where the field is actually zero :</span>
<span class="s2">        Brho[np.isnan(Brho)] = 0</span>

<span class="s2">        B = np.c_[np.cos(theta)*Brho, np.sin(theta)*Brho, Bz ]</span>

<span class="s2">        # Rotate the field back in the lab&#39;s frame</span>
<span class="s2">        B = np.dot(B, trans)</span>

<span class="s2">        Bx, By, Bz = B.T</span>
<span class="s2">        Bx = np.reshape(Bx, X.shape)</span>
<span class="s2">        By = np.reshape(By, X.shape)</span>
<span class="s2">        Bz = np.reshape(Bz, X.shape)</span>

<span class="s2">        Bnorm = np.sqrt(Bx**2 + By**2 + Bz**2)</span>

<span class="s2">        # We need to threshold ourselves, rather than with VTK, to be able</span>
<span class="s2">        # to use an ImageData</span>
<span class="s2">        Bmax = 10 * np.median(Bnorm)</span>

<span class="s2">        Bx[Bnorm &gt; Bmax] = np.NAN</span>
<span class="s2">        By[Bnorm &gt; Bmax] = np.NAN</span>
<span class="s2">        Bz[Bnorm &gt; Bmax] = np.NAN</span>
<span class="s2">        Bnorm[Bnorm &gt; Bmax] = np.NAN</span>

<span class="s2">        self.Bx = Bx</span>
<span class="s2">        self.By = By</span>
<span class="s2">        self.Bz = Bz</span>
<span class="s2">        return Bnorm</span>


<span class="s2">##############################################################################</span>
<span class="s2"># The application object</span>
<span class="s2">class Application(HasTraits):</span>

<span class="s2">    scene = Instance(MlabSceneModel, (), editor=SceneEditor())</span>

<span class="s2">    # The mayavi engine view.</span>
<span class="s2">    engine_view = Instance(EngineView)</span>

<span class="s2">    coils = List(Instance(Loop, (), allow_none=False),</span>
<span class="s2">                        editor=ListEditor(style=&#39;custom&#39;),</span>
<span class="s2">                        value=[ Loop(position=(0, 0, -0.05), ),</span>
<span class="s2">                                 Loop(position=(0, 0,  0.05), ), ])</span>


<span class="s2">    Bx    = Array(value=np.zeros_like(X))</span>
<span class="s2">    By    = Array(value=np.zeros_like(X))</span>
<span class="s2">    Bz    = Array(value=np.zeros_like(X))</span>
<span class="s2">    Bnorm = Array(value=np.zeros_like(X))</span>

<span class="s2">    vector_field = None</span>

<span class="s2">    def __init__(self, **traits):</span>
<span class="s2">        HasTraits.__init__(self, **traits)</span>
<span class="s2">        self.engine_view = EngineView(engine=self.scene.engine)</span>


<span class="s2">    @on_trait_change(&#39;scene.activated,coils&#39;)</span>
<span class="s2">    def init_view(self):</span>
<span class="s2">        if self.scene._renderer is not None:</span>
<span class="s2">            self.scene.scene_editor.background = (0, 0, 0)</span>
<span class="s2">            for coil in self.coils:</span>
<span class="s2">                coil.app = self</span>
<span class="s2">                coil.display()</span>

<span class="s2">            self.visualize_field()</span>

<span class="s2">    def visualize_field(self):</span>
<span class="s2">        self.Bx    = np.zeros_like(X)</span>
<span class="s2">        self.By    = np.zeros_like(X)</span>
<span class="s2">        self.Bz    = np.zeros_like(X)</span>
<span class="s2">        self.Bnorm = np.zeros_like(X)</span>
<span class="s2">        self.scene.scene.disable_render = True</span>
<span class="s2">        for coil in self.coils:</span>
<span class="s2">            self.Bx += coil.Bx</span>
<span class="s2">            self.By += coil.By</span>
<span class="s2">            self.Bz += coil.Bz</span>

<span class="s2">        self.Bnorm = np.sqrt(self.Bx**2 + self.By**2 + self.Bz**2)</span>

<span class="s2">        if self.vector_field is None:</span>
<span class="s2">            self.vector_field = self.scene.mlab.pipeline.vector_field(</span>
<span class="s2">                                    X, Y, Z, self.Bx, self.By, self.Bz,</span>
<span class="s2">                                    scalars=self.Bnorm,</span>
<span class="s2">                                    name=&#39;B field&#39;)</span>
<span class="s2">            vectors = self.scene.mlab.pipeline.vectors(self.vector_field,</span>
<span class="s2">                                    mode=&#39;arrow&#39;, resolution=10,</span>
<span class="s2">                                    mask_points=6, colormap=&#39;YlOrRd&#39;,</span>
<span class="s2">                                    scale_factor=2*np.abs(X[0,0,0]</span>
<span class="s2">                                                          -X[1,1,1]) )</span>
<span class="s2">            vectors.module_manager.vector_lut_manager.reverse_lut = True</span>
<span class="s2">            vectors.glyph.mask_points.random_mode = False</span>
<span class="s2">            self.scene.mlab.axes()</span>
<span class="s2">            self.scp = self.scene.mlab.pipeline.scalar_cut_plane(</span>
<span class="s2">                                                      self.vector_field,</span>
<span class="s2">                                                      colormap=&#39;hot&#39;)</span>
<span class="s2">        else:</span>
<span class="s2">            # Modify in place the data source. The visualization will</span>
<span class="s2">            # update automaticaly</span>
<span class="s2">            self.vector_field.mlab_source.trait_set(</span>
<span class="s2">                u=self.Bx, v=self.By, w=self.Bz, scalars=self.Bnorm)</span>
<span class="s2">        self.scene.scene.disable_render = False</span>


<span class="s2">    view = View(HSplit(</span>
<span class="s2">                    VSplit(Item(name=&#39;engine_view&#39;,</span>
<span class="s2">                                   style=&#39;custom&#39;,</span>
<span class="s2">                                   resizable=True),</span>
<span class="s2">                            Item(&#39;coils&#39;, springy=True),</span>
<span class="s2">                        show_labels=False),</span>
<span class="s2">                        &#39;scene&#39;,</span>
<span class="s2">                        show_labels=False),</span>
<span class="s2">                    resizable=True,</span>
<span class="s2">                    title=&#39;Coils...&#39;,</span>
<span class="s2">                    height=0.8,</span>
<span class="s2">                    width=0.8,</span>
<span class="s2">                )</span>


<span class="s2">##############################################################################</span>
<span class="s2">if __name__ == &#39;__main__&#39;:</span>
<span class="s2">    app = Application()</span>
<span class="s2">    app.configure_traits()</span>

</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/mayavi-logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="example_volume_slicer.html"
                        title="previous chapter">Volume slicer example</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="example_volume_slicer_advanced.html"
                        title="next chapter">Volume slicer advanced example</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/auto/example_coil_design_application.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="example_volume_slicer_advanced.html" title="Volume slicer advanced example"
             >next</a> |</li>
        <li class="right" >
          <a href="example_volume_slicer.html" title="Volume slicer example"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">mayavi 4.6.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="examples.html" >Example gallery</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2008-2018, Enthought Inc..
      Last updated on Aug 08, 2018.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.1.
    </div>
  </body>
</html>